name: Publish

on:
  workflow_dispatch:

permissions:
  contents: write

# ==========================================================================
# Fast Checks
# ==========================================================================

jobs:
  check:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: jdx/mise-action@v3
      - run: mise run restore
      - run: mise run check

  # ==========================================================================
  # Core Tests
  # ==========================================================================

  test:
    name: Test (${{ matrix.os }})
    needs: [check]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v6
      - uses: jdx/mise-action@v3
      - run: mise run restore
      - run: mise run build
      - run: mise run test

  # ==========================================================================
  # Pack
  # ==========================================================================

  pack:
    name: Pack NuGet
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: jdx/mise-action@v3
      - run: mise run restore
      - run: mise run build
      - run: mise run pack

      - uses: actions/upload-artifact@v6
        with:
          name: nuget-packages
          path: |
            nupkg/*.nupkg
            nupkg/*.snupkg

  # ==========================================================================
  # Publish
  # ==========================================================================

  publish:
    name: Create Release
    needs: [pack]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Read version
        id: version
        run: echo "version=$(cat VERSION)" >> "$GITHUB_OUTPUT"

      - uses: actions/download-artifact@v7
        with:
          name: nuget-packages
          path: nupkg

      - name: Create tag
        run: |
          git tag "v${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"

      - name: Create GitHub release
        run: gh release create "v${{ steps.version.outputs.version }}" --generate-notes nupkg/*.nupkg nupkg/*.snupkg
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to NuGet
        run: dotnet nuget push nupkg/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
